# 腾讯云部署指南 - 心跳打卡应用

## 🎯 部署概览

我们将在腾讯云上部署你的心跳打卡应用，包括：
- 购买和配置云服务器
- 安装Docker环境
- 配置域名和SSL证书
- 部署应用
- 配置安全组和防火墙

## 📋 准备工作

### 1. 腾讯云账号准备
- 注册腾讯云账号：https://cloud.tencent.com/
- 完成实名认证
- 充值一定金额（建议100-200元）

### 2. 需要购买的服务
- **云服务器CVM**（必需）
- **域名**（推荐，用于HTTPS）
- **SSL证书**（免费，用于HTTPS）

## 🖥️ 第一步：购买云服务器

### 1.1 进入CVM控制台
1. 登录腾讯云控制台
2. 搜索"云服务器CVM"
3. 点击"立即购买"

### 1.2 选择配置
**推荐配置：**
- **地域**：选择离你最近的地区（如北京、上海、广州）
- **机型**：标准型S5
- **CPU内存**：2核4GB（最低1核2GB也可以）
- **操作系统**：Ubuntu Server 20.04 LTS 64位
- **系统盘**：高性能云硬盘 50GB
- **公网带宽**：按流量计费，峰值带宽5Mbps
- **安全组**：选择"放通22,80,443,3389端口和ICMP协议"

### 1.3 设置登录方式
- **登录方式**：选择"设置密码"
- **用户名**：ubuntu（默认）
- **密码**：设置一个强密码（记住这个密码！）

### 1.4 购买时长
- 建议先买1个月测试，确认没问题后再续费

## 🌐 第二步：购买域名（可选但推荐）

### 2.1 购买域名
1. 在腾讯云控制台搜索"域名注册"
2. 搜索你想要的域名
3. 选择合适的域名购买（.com/.cn/.top等）

### 2.2 域名备案（如果选择国内服务器）
- 如果服务器在中国大陆，需要进行ICP备案
- 备案流程约15-20个工作日
- 可以先用IP地址测试，备案完成后再绑定域名

## 🔧 第三步：连接服务器

### 3.1 获取服务器信息
1. 在CVM控制台找到你的服务器
2. 记录**公网IP地址**
3. 确认服务器状态为"运行中"

### 3.2 连接服务器
**Windows用户：**
```powershell
# 使用PowerShell连接（Windows 10+）
ssh ubuntu@你的服务器IP

# 或者下载PuTTY工具连接
```

**Mac/Linux用户：**
```bash
ssh ubuntu@你的服务器IP
```

首次连接会提示是否信任，输入`yes`，然后输入你设置的密码。

## 🐳 第四步：安装Docker环境

连接到服务器后，执行以下命令：

### 4.1 更新系统
```bash
sudo apt update
sudo apt upgrade -y
```

### 4.2 安装Docker
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 将当前用户添加到docker组
sudo usermod -aG docker ubuntu

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
```

### 4.3 安装Docker Compose
```bash
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 4.4 验证安装
```bash
# 重新登录以使docker组生效
exit
ssh ubuntu@你的服务器IP

# 验证Docker
docker --version
docker-compose --version
```

## 📁 第五步：上传项目代码

### 5.1 方法一：使用Git（推荐）
```bash
# 安装Git
sudo apt install git -y

# 克隆你的项目（如果代码在GitHub/Gitee上）
git clone https://github.com/你的用户名/heartbeat.git
cd heartbeat
```

### 5.2 方法二：使用SCP上传
在你的本地电脑上：
```bash
# 压缩项目文件
tar -czf heartbeat.tar.gz heartbeat/

# 上传到服务器
scp heartbeat.tar.gz ubuntu@你的服务器IP:~/

# 在服务器上解压
ssh ubuntu@你的服务器IP
tar -xzf heartbeat.tar.gz
cd heartbeat
```

## ⚙️ 第六步：配置环境

### 6.1 配置生产环境变量
```bash
# 复制环境变量模板
cp .env.example .env.production

# 编辑配置文件
nano .env.production
```

**重要配置项：**
```bash
# 生成强密钥
SECRET_KEY=你生成的强密钥

# 如果有域名，填入域名；否则填入服务器IP
DOMAIN=你的域名.com
FRONTEND_URL=https://你的域名.com
BACKEND_URL=https://你的域名.com/api

# 如果暂时没有域名，可以先用IP
# DOMAIN=你的服务器IP
# FRONTEND_URL=http://你的服务器IP
# BACKEND_URL=http://你的服务器IP:8000
```

### 6.2 生成密钥
```bash
# 使用Python生成密钥
python3 secret_key_gen.py
```

### 6.3 创建必要目录
```bash
mkdir -p static/uploads
mkdir -p nginx/ssl
```

## 🔒 第七步：配置SSL证书（如果有域名）

### 7.1 申请免费SSL证书
1. 在腾讯云控制台搜索"SSL证书"
2. 点击"申请免费证书"
3. 填入你的域名
4. 选择DNS验证
5. 按提示添加DNS记录
6. 等待证书签发（通常几分钟到几小时）

### 7.2 下载并配置证书
1. 证书签发后，下载Nginx格式的证书
2. 解压得到两个文件：`证书ID.crt` 和 `证书ID.key`
3. 上传到服务器：

```bash
# 在本地上传证书文件
scp 证书ID.crt ubuntu@你的服务器IP:~/heartbeat/nginx/ssl/cert.pem
scp 证书ID.key ubuntu@你的服务器IP:~/heartbeat/nginx/ssl/key.pem
```

### 7.3 配置域名解析
1. 在腾讯云DNS控制台
2. 添加A记录：`你的域名.com` -> `你的服务器IP`
3. 添加A记录：`www.你的域名.com` -> `你的服务器IP`

## 🚀 第八步：部署应用

### 8.1 修改配置文件
```bash
# 编辑nginx配置，替换域名
nano nginx/nginx.conf
# 将所有 "your-domain.com" 替换为你的实际域名

# 编辑前端nginx配置
nano heartbeat-frontend/nginx.conf
```

### 8.2 部署应用
```bash
# 给部署脚本执行权限
chmod +x deploy.sh

# 部署生产环境
./deploy.sh prod
```

### 8.3 检查服务状态
```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs

# 如果有问题，查看具体服务日志
docker-compose logs backend
docker-compose logs frontend
docker-compose logs nginx
```

## 🛡️ 第九步：配置安全组

### 9.1 在腾讯云控制台配置安全组
1. 进入CVM控制台
2. 点击你的服务器实例
3. 点击"安全组"标签
4. 编辑安全组规则

**需要开放的端口：**
- **22** (SSH) - 来源：你的IP地址
- **80** (HTTP) - 来源：0.0.0.0/0
- **443** (HTTPS) - 来源：0.0.0.0/0
- **8000** (后端API，可选) - 来源：0.0.0.0/0

### 9.2 配置服务器防火墙
```bash
# 启用UFW防火墙
sudo ufw enable

# 允许SSH
sudo ufw allow 22

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 查看防火墙状态
sudo ufw status
```

## 🎉 第十步：测试访问

### 10.1 测试访问
- **如果有域名和SSL**：访问 `https://你的域名.com`
- **如果只有IP**：访问 `http://你的服务器IP`

### 10.2 功能测试
1. 注册新用户
2. 登录系统
3. 创建打卡任务
4. 上传图片
5. 查看打卡记录

## 🔧 常见问题解决

### 问题1：无法访问网站
```bash
# 检查容器状态
docker-compose ps

# 检查端口占用
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# 重启服务
docker-compose restart
```

### 问题2：SSL证书问题
```bash
# 检查证书文件
ls -la nginx/ssl/

# 测试证书
openssl x509 -in nginx/ssl/cert.pem -text -noout
```

### 问题3：数据库问题
```bash
# 检查数据库文件
ls -la a_love_story.db

# 进入后端容器检查
docker-compose exec backend bash
```

## 📊 监控和维护

### 日常维护命令
```bash
# 查看系统资源使用
htop
df -h

# 查看Docker容器状态
docker stats

# 备份数据库
cp a_love_story.db backup_$(date +%Y%m%d).db

# 查看应用日志
docker-compose logs -f --tail=100
```

### 更新应用
```bash
# 拉取最新代码
git pull

# 重新部署
docker-compose down
docker-compose build --no-cache
docker-compose --profile production up -d
```

## 💰 费用估算

**月费用预估：**
- 云服务器CVM (2核4GB)：约80-120元/月
- 域名：约50-100元/年
- SSL证书：免费
- 流量费：约10-30元/月（取决于访问量）

**总计：约100-150元/月**

## 📞 获取帮助

如果遇到问题：
1. 查看腾讯云文档：https://cloud.tencent.com/document
2. 腾讯云工单系统
3. 检查应用日志：`docker-compose logs`

---

**恭喜！🎉 你的心跳打卡应用现在已经在腾讯云上运行了！**