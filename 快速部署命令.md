# 心跳打卡应用 - 快速部署命令

## 🎉 网络已恢复正常！

现在可以开始正式部署了。请按以下步骤执行：

## 📋 部署步骤

### 1. 更新系统并安装Docker

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装Docker和Docker Compose
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 将用户添加到docker组
sudo usermod -aG docker $USER

# 重新登录以使组权限生效
newgrp docker

# 验证安装
docker --version
docker-compose --version
```

### 2. 上传项目代码

**方法1：使用Git克隆（推荐）**
```bash
# 如果项目已上传到GitHub
git clone https://github.com/your-username/heartbeat.git
cd heartbeat
```

**方法2：使用SCP上传（从本地）**
```bash
# 在本地Windows PowerShell中执行
scp -r d:\university\heartbeat ubuntu@your-server-ip:~/
```

**方法3：手动创建项目结构**
```bash
# 创建项目目录
mkdir -p ~/heartbeat
cd ~/heartbeat

# 然后逐个上传文件，或者使用以下命令创建必要文件
```

### 3. 配置环境变量

```bash
# 进入项目目录
cd ~/heartbeat

# 复制环境变量模板
cp .env.example .env.production

# 编辑生产环境配置
nano .env.production

# 需要修改的关键配置：
# DATABASE_URL=postgresql://heartbeat:your_password@db:5432/heartbeat
# JWT_SECRET_KEY=your_generated_secret_key
# DOMAIN=your-domain.com 或者 your-server-ip
```

### 4. 生成JWT密钥

```bash
# 生成安全的JWT密钥
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# 或者使用项目提供的脚本
python3 secret_key_gen.py
```

### 5. 一键部署

```bash
# 给部署脚本执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh

# 或者手动执行Docker Compose
docker-compose -f docker-compose.yml up -d
```

### 6. 配置安全组

在腾讯云控制台配置安全组，开放以下端口：
- **80** (HTTP)
- **443** (HTTPS) 
- **22** (SSH)

### 7. 测试访问

```bash
# 检查服务状态
docker-compose ps

# 查看日志
docker-compose logs

# 测试API访问
curl http://localhost/api/health

# 测试前端访问
curl http://localhost/
```

## 🔧 常用管理命令

```bash
# 查看运行状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 更新应用
git pull
docker-compose down
docker-compose up -d --build

# 备份数据库
docker-compose exec db pg_dump -U heartbeat heartbeat > backup.sql
```

## 🌐 访问应用

部署成功后，可以通过以下方式访问：

- **前端应用**: `http://your-server-ip/`
- **API文档**: `http://your-server-ip/docs`
- **健康检查**: `http://your-server-ip/api/health`

## 🚨 故障排除

如果遇到问题：

1. **检查服务状态**: `docker-compose ps`
2. **查看错误日志**: `docker-compose logs service-name`
3. **重启服务**: `docker-compose restart`
4. **检查端口占用**: `netstat -tlnp | grep :80`
5. **检查防火墙**: `sudo ufw status`

## 📞 获取帮助

如果需要帮助，请提供：
- 错误日志输出
- 服务运行状态
- 系统环境信息