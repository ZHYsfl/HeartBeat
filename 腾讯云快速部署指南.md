# 腾讯云快速部署指南 - 解决网络问题

## 🚨 当前问题分析

根据您提供的服务器信息，发现以下问题：

1. **网络连接问题**：无法连接到外部镜像源和DNS解析失败
2. **包更新失败**：apt update 被中断，无法正常更新系统包
3. **DNS解析问题**：ping baidu.com 失败，100% 丢包

## 🔧 立即解决方案

### 步骤1：修复网络和DNS配置

```bash
# 1. 下载并运行网络修复脚本
wget https://raw.githubusercontent.com/your-repo/heartbeat/main/fix-network.sh
chmod +x fix-network.sh
sudo ./fix-network.sh

# 或者手动执行以下命令：

# 修复DNS
sudo tee /etc/systemd/resolved.conf > /dev/null <<EOF
[Resolve]
DNS=119.29.29.29 223.5.5.5 8.8.8.8
FallbackDNS=114.114.114.114 1.1.1.1
EOF

sudo systemctl restart systemd-resolved

# 配置腾讯云内网镜像源
sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup
sudo tee /etc/apt/sources.list > /dev/null <<EOF
deb http://mirrors.tencentyun.com/ubuntu/ jammy main restricted universe multiverse
deb http://mirrors.tencentyun.com/ubuntu/ jammy-updates main restricted universe multiverse
deb http://mirrors.tencentyun.com/ubuntu/ jammy-backports main restricted universe multiverse
deb http://mirrors.tencentyun.com/ubuntu/ jammy-security main restricted universe multiverse
EOF

# 清理并更新
sudo apt clean
sudo apt update
```

### 步骤2：验证网络连接

```bash
# 测试DNS
nslookup baidu.com

# 测试网络连通性
ping -c 3 119.29.29.29

# 测试镜像源
curl -I http://mirrors.tencentyun.com/ubuntu/
```

### 步骤3：安装Docker

网络修复后，运行Docker安装脚本：

```bash
# 下载Docker安装脚本
wget https://raw.githubusercontent.com/your-repo/heartbeat/main/install-docker.sh
chmod +x install-docker.sh
sudo ./install-docker.sh

# 重新登录以使docker组生效
newgrp docker
```

## 🚀 快速部署应用

网络和Docker安装完成后：

### 1. 上传项目代码

```bash
# 方法1：使用git克隆
git clone https://github.com/your-username/heartbeat.git
cd heartbeat

# 方法2：使用scp上传（从本地）
# scp -r heartbeat/ ubuntu@your-server-ip:~/
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env.production

# 编辑配置文件
nano .env.production

# 生成JWT密钥
python3 secret_key_gen.py
```

### 3. 一键部署

```bash
# 给部署脚本执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

## 🔍 故障排除

### 如果仍然无法连接网络：

1. **检查安全组设置**：
   - 确保开放了80、443、22端口
   - 检查出站规则是否允许HTTP/HTTPS

2. **检查防火墙**：
   ```bash
   sudo ufw status
   sudo ufw allow 80
   sudo ufw allow 443
   sudo ufw allow 22
   ```

3. **检查路由表**：
   ```bash
   ip route show
   ```

4. **重启网络服务**：
   ```bash
   sudo systemctl restart networking
   sudo systemctl restart systemd-networkd
   ```

### 如果Docker安装失败：

1. **使用离线安装包**：
   ```bash
   # 下载Docker离线包
   wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.21.tgz
   tar xzvf docker-20.10.21.tgz
   sudo cp docker/* /usr/bin/
   ```

2. **使用snap安装**：
   ```bash
   sudo snap install docker
   ```

## 📞 获取帮助

如果问题仍然存在，请：

1. 检查腾讯云控制台的网络配置
2. 联系腾讯云技术支持
3. 确认服务器是否有公网IP
4. 检查VPC和子网配置

## 🎯 预期结果

修复完成后，您应该能够：
- ✅ 正常ping通外部网站
- ✅ apt update 成功执行
- ✅ Docker正常安装和运行
- ✅ 应用成功部署并可访问